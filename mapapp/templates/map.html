<!DOCTYPE html>
<html>
<head>
    <title>Nearest Shelters</title>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
</head>
<body>

<div id="map" style="height: 400px;"></div>

<!-- 위치 정보 표시 -->
<div id="location-info">
    <p>Your Location: <span id="user-location"></span></p>
    <p>Nearest Shelters:</p>
    <ul id="shelters-list"></ul>
</div>

<script>
    var map = L.map('map').setView([0, 0], 13);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
    }).addTo(map);

    if ("geolocation" in navigator) {
        navigator.geolocation.getCurrentPosition(function(position) {
            var userLatitude = position.coords.latitude;
            var userLongitude = position.coords.longitude;

            map.setView([userLatitude, userLongitude], 13);
            var userMarker = L.marker([userLatitude, userLongitude]).addTo(map);
            userMarker.bindPopup("Your Location").openPopup();

            document.getElementById('user-location').textContent = '(' + userLatitude + ', ' + userLongitude + ')';
            
            fetch('/map_view/?geolocation=1&latitude=' + userLatitude + '&longitude=' + userLongitude)
                .then(response => response.json())
                .then(data => {
                    var sheltersList = document.getElementById('shelters-list');
                    
                    // Show nearest shelter
                    var nearestShelter = data.nearest_shelters[0];
                    var shelterMarker = L.marker([nearestShelter.ycord, nearestShelter.xcord]).addTo(map);
                    shelterMarker.bindPopup("<b>" + nearestShelter.vt_acmdfclty_nm + "</b><br>" + nearestShelter.dtl_adres).openPopup();

                    // Show other shelters and add to shelters list
                    data.nearest_shelters.slice(0).forEach(shelter => {
                        var shelterMarker = L.marker([shelter.ycord, shelter.xcord]).addTo(map);
                        shelterMarker.bindPopup("<b>" + shelter.vt_acmdfclty_nm + "</b><br>" + shelter.dtl_adres);
                        
                        var shelterItem = document.createElement('li');
                        shelterItem.textContent = shelter.vt_acmdfclty_nm + ': (' + shelter.ycord + ', ' + shelter.xcord + ')';
                        sheltersList.appendChild(shelterItem);
                    });
                });
        });
    }
    
</script>

</body>
</html>
